from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate
from app.core.config import settings

# ูุณุชุฎุฏู ูููุฐุฌ ุฐูู ููุตูุงุบุฉ (ููุถู temperature ููุฎูุถุฉ ููุฏูุฉ)
llm = ChatOpenAI(model="gpt-4o-mini", api_key=settings.OPENAI_API_KEY, temperature=0.3)

def writer_node(state):
    """
    ุนุงูู ุงููุชุงุจุฉ (Writer Worker).
    ุงููููุฉ: ุชุฌููุน ุชูุงุฑูุฑ ุงููุฑูู (ุฃุณุงุณูุ ูููุ ูุดุงุนุฑุ ูุฎุงุทุฑ)
    ููุชุงุจุฉ ุงูุชูุฑูุฑ ุงูุงุณุชุดุงุฑู ุงูููุงุฆู ุงูููุญุฏ.
    """
    print("--- ๐ Writer: ุตูุงุบุฉ ุงููุณูุฏุฉ ุงูููุงุฆูุฉ ููุชูุฑูุฑ ---")
    
    # 1. ุชุฌููุน ุงููุนูููุงุช ูู ููู ุงููุถูุฉ (State)
    symbol = state.get('symbol')
    
    # ุฌูุจ ุงูุชูุงุฑูุฑ ุงููุฑุนูุฉ (ูุน ูุถุน ููู ุงูุชุฑุงุถูุฉ ูู ุญุงู ูุดู ุฃุญุฏ ุงูุนูุงู)
    fund_summary = state.get('fundamental_summary', 'ุจูุงูุงุช ุบูุฑ ูุชููุฑุฉ.')
    tech_report = state.get('technical_report', 'ุจูุงูุงุช ุบูุฑ ูุชููุฑุฉ.')
    
    sent_data = state.get('sentiment_report', {})
    sent_summary = sent_data.get('summary', 'ูุง ุชูุฌุฏ ุฃุฎุจุงุฑ.')
    sent_score = sent_data.get('score', 0)
    
    risk_data = state.get('risk_report', {})
    risk_sanity = risk_data.get('sanity', 'ุบูุฑ ููุญูุต')
    risk_volatility = risk_data.get('volatility', {}).get('message', 'ุบูุฑ ูุนุฑูู')

    # 2. ููุฏุณุฉ ุงูุฃูุฑ (The Editor Prompt)
    # ููุฌู ุงููููุฐุฌ ููููู "ูุฏูุฑ ุฃุจุญุงุซ" ููุชุจ ูุนููู ูุคุณุณู
    prompt = PromptTemplate.from_template("""
    ุฃูุช ุฑุฆูุณ ุชุญุฑูุฑ ูุณู ุงูุฃุจุญุงุซ ุงููุงููุฉ ูู ูุคุณุณุฉ ุงุณุชุซูุงุฑูุฉ ูุจุฑู.
    ูุฏูู ูุณูุฏุงุช ูู ูุฑูู ุงูุชุญููู ุจุฎุตูุต ุณูู: {symbol}.
    
    ูููุชู: ุฏูุฌ ูุฐู ุงููุนูููุงุช ูู ุชูุฑูุฑ ุงุญุชุฑุงูู ูุงุญุฏุ ูุชูุงุณูุ ููุงุถุญ ุจุงููุบุฉ ุงูุนุฑุจูุฉ.
    
    --- ุงูุจูุงูุงุช ุงููุชููุฑุฉ ---
    1. ุงูุชุญููู ุงูุฃุณุงุณู (ุตุญุฉ ุงูุดุฑูุฉ):
    {fund_summary}
    
    2. ุงูุชุญููู ุงูููู (ุญุฑูุฉ ุงูุณุนุฑ):
    {tech_report}
    
    3. ุชุญููู ุงููุดุงุนุฑ ูุงูุฃุฎุจุงุฑ (Score: {sent_score}):
    {sent_summary}
    
    4. ุชูุฑูุฑ ุงููุฎุงุทุฑ ูุงูุฃูุงู:
    - ุฌูุฏุฉ ุงูุจูุงูุงุช: {risk_sanity}
    - ุชุฐุจุฐุจ ุงูุณูู: {risk_volatility}
    
    --- ุงููุทููุจ ูู ุงูุชูุฑูุฑ ---
    ุงูุชุจ ุงูุชูุฑูุฑ ุจุงููููู ุงูุชุงูู (ุงุณุชุฎุฏู ุชูุณูู Markdown):
    
    ### 1. ุงูููุฎุต ุงูุชูููุฐู ูุงูุชูุตูุฉ
    (ุณุทุฑูู ููุฎุตุงู ุงููุถุน: ูู ุงูุณูู ููุดุฑุงุกุ ุงูุจูุนุ ุฃู ุงูุงูุชุธุงุฑุ ูู ุฌุฑูุฆุงู ููู ุญุฐุฑุงู).
    
    ### 2. ุงููุธุฑุฉ ุงูุฃุณุงุณูุฉ (ุงููุงููุฉ)
    (ูุฎุต ูุถุน ุงูุดุฑูุฉ ุงููุงูู: ูู ูู ุฑุงุจุญุฉุ ูู ุฏููููุง ุฎุทูุฑุฉุ).
    
    ### 3. ุงูุชูููุช ุงูููู ูุงูุณูู
    (ุงุฏูุฌ ุงูุชุญููู ุงูููู ูุน ุงูุฃุฎุจุงุฑ: ูู ุงูุณุนุฑ ููุงุณุจ ููุฏุฎูู ุงูุขูุ).
    
    ### 4. ุชุญุฐูุฑุงุช ุงููุฎุงุทุฑ
    (ุงุฐูุฑ ุฃู ูุฎุงุทุฑ ุธูุฑุช ูู ุชูุฑูุฑ ุงูุฃูุงู ุฃู ุงูุฃุฎุจุงุฑ ุงูุณูุจูุฉ).
    
    ---
    ุงูุฃุณููุจ: ุงุญุชุฑุงููุ ููุถูุนูุ ููุจุงุดุฑ. ุชุฌูุจ ุงูุญุดู.
    """)
    
    # 3. ุชุดุบูู ุงููุงุชุจ
    chain = prompt | llm
    result = chain.invoke({
        "symbol": symbol,
        "fund_summary": fund_summary,
        "tech_report": tech_report,
        "sent_summary": sent_summary,
        "sent_score": sent_score,
        "risk_sanity": risk_sanity,
        "risk_volatility": risk_volatility
    })
    
    final_text = result.content
    
    # 4. ุชุญุฏูุซ ุงูุญุงูุฉ
    # ูุถุน ุงูุชูุฑูุฑ ูู ุฎุงูุฉ "ุงููุณูุฏุฉ" (draft) ูุฃููุง ูุฏ ุชุฎุถุน ูููุฑุงุฌุนุฉ ูุงุญูุงู
    # ุฃู ูุถุนูุง ูู "ุงูููุงุฆู" ูุจุงุดุฑุฉ ุฅุฐุง ูู ููู ููุงู ูุฏูู
    return {
        "draft_report": final_text,
        "final_report": final_text 
    }